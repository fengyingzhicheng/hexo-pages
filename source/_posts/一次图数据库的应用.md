---
title: 一次图数据库的应用
date: 2021-2-24 15:40:24
updated: 2021-2-24 15:40:24
categories: 
           - NoSQL
tags:
           - Neo4J
---


# 使用背景

项目中用到了需要记录整个数据经过任务调度处理后的数据流转过程，在【资产目录】管理模块需要对整个数据的血缘关系进行记录，使用传统关系型数据库需要对进行递归查，效率不高。接触到了图数据库Neo4J的概念，使用图数据库的查询语言CQL可以针对层级查询有明显提升。

# 关系存储模型

## 树存储

树结构查询某个结点子集或者父集的情况也时常存在，针对这种情况常使用路径树存储树从根到各个结点经过的路径，经过一个字段冗余避免了递归嵌套查询

| id | parentId | path       |
| -- | -------- | ---------- |
| 1  | 1        | 1          |
| 2  | 1        | 1->2       |
| 3  | 2        | 1->2->3    |
| 4  | 2        | 1->2->4    |
| 5  | 4        | 1->2->4->5 |

这样查询2下面的所有子集，即可以通过一次模糊匹配完成

```sql
SELECT * FROM TREE WHERE path LIKE '1->2%'
```

查询4的所有父集的查询语句为

```sql
SELECT * FROM TREE WHERE path + '%' LIKE '1->2->4'
```

## 图结构

使用传统的关系型数据库存储图，常见存储结构

`Node`

| id |
| -- |
| 1  |
| 2  |
| 3  |
| 4  |
| 5  |

`Edge`

| id | input | output | weight |
| -- | ----- | ------ | ------ |
| 1  | 1     | 2      | 5      |
| 2  | 2     | 3      | 10     |
| 3  | 3     | 4      | 6      |
| 4  | 3     | 5      | 8      |

> 因为图是可以有多个入线多个出线的 无法使用路径枚举，查询图必须要经过递归查询，使用传统SQL数据库递归查询效率低。
>

# Neo4J介绍

## Neo4j属性图数据模型

属性图模型规则

* 表示节点，关系和属性中的数据
* 节点和关系都包含属性
* 关系连接节点
* 属性是键值对
* 节点用圆圈表示，关系用方向键表示。
* 关系具有方向：单向和双向。
* 每个关系包含“开始节点”或“从节点”和“到节点”或“结束节点”

![image.png](assets/image-20220320144858-xlyhx2y.png)

# CQL

## Neo4j CQL命令

| CQL命令/条       | 用法                         |
| ---------------- | ---------------------------- |
| CREATE<br />创建       | 创建节点，关系和属性         |
| MATCH<br />匹配        | 检索有关节点，关系和属性数据 |
| RETURN<br />返回       | 返回查询结果                 |
| WHERE<br />哪里        | 提供条件过滤检索数据         |
| DELETE<br />删除       | 删除节点和关系               |
| REMOVE<br />移除       | 删除节点和关系的属性         |
| ORDER BY以…排序<br /> | 排序检索数据                 |
| SET<br />组            | 添加或更新标签               |

## 复杂查询

1. 深度查询父集（血缘）

```sql
MATCH (n:Person)-[*0..10]-(m:Person) where m.name="Steve" RETURN n
```

![image.png](assets/image-20220320145332-6ktrzgx.png)

2. 查询子集
   ```sql
   MATCH (n:Person)-[*0..10]-(m:Person) where n.name="Liz" RETURN m
   ```

![image.png](assets/image-20220320145552-02upj93.png)